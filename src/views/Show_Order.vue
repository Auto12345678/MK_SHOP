<template>
  <div class="container my-5">
    <h2 class="text-center mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

    <!-- üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
      <input
        type="text"
        class="form-control w-50"
        placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞..."
        v-model="searchTable"
      />

      <!-- üî¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ -->
      <div>
        <label class="me-2">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤:</label>
        <select v-model.number="rowsPerPage" class="form-select d-inline-block w-auto">
          <option :value="5">5</option>
          <option :value="10">10</option>
          <option :value="20">20</option>
          <option :value="50">50</option>
        </select>
      </div>
    </div>

    <!-- ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î -->
    <div v-if="loading" class="text-center">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div v-if="error" class="text-danger text-center">{{ error }}</div>

    <!-- üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <table v-if="paginatedOrders.length > 0" class="table table-bordered table-striped mt-3">
      <thead class="table-primary text-center">
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
          <th>‡πÇ‡∏ï‡πä‡∏∞</th>
          <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(order, index) in paginatedOrders" :key="index">
          <td>{{ order.order_id }}</td>
          <td>{{ order.table_no }}</td>
          <td>{{ order.product_id }}</td>
          <td>{{ order.product_name }}</td>
          <td>{{ order.quantity }}</td>
          <td>{{ Number(order.price).toFixed(2) }}</td>
          <td>{{ Number(order.subtotal).toFixed(2) }}</td>
          <td>{{ order.order_date }}</td>
          <td>
            <select v-model="order.status" @change="updateStatus(order)">
              <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
              <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- ‚ùó ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div v-else-if="!loading" class="text-center text-muted">
      ‚ùó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    </div>

    <!-- üìÑ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ -->
    <div v-if="totalPages > 1" class="d-flex justify-content-center align-items-center mt-4">
      <button
        class="btn btn-secondary me-2"
        :disabled="currentPage === 1"
        @click="currentPage--"
      >
        ‚¨Ö ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      </button>

      <span>‡∏´‡∏ô‡πâ‡∏≤ {{ currentPage }} ‡∏à‡∏≤‡∏Å {{ totalPages }}</span>

      <button
        class="btn btn-secondary ms-2"
        :disabled="currentPage === totalPages"
        @click="currentPage++"
      >
        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°
      </button>
    </div>
  </div>
</template>

<script>
import { ref, onMounted, computed, watch } from "vue";

export default {
  name: "OrderList",
  setup() {
    const orders = ref([]);
    const loading = ref(true);
    const error = ref(null);
    const searchTable = ref("");
    const currentPage = ref(1);
    const rowsPerPage = ref(10); // üëà ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 10 ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤

    const fetchOrders = async () => {
      try {
        const res = await fetch("http://localhost/project_MK/php_api/show_orders.php");
        const data = await res.json();

        if (data.success) {
          orders.value = data.data.map((o) => ({
            ...o,
            status: o.status || "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
          }));
        } else {
          error.value = data.message;
        }
      } catch (err) {
        error.value = err.message;
      } finally {
        loading.value = false;
      }
    };

    onMounted(fetchOrders);

    // üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏ï‡πä‡∏∞
    const filteredOrders = computed(() => {
      if (!searchTable.value) return orders.value;
      return orders.value.filter((order) =>
        order.table_no.toString().includes(searchTable.value)
      );
    });

    // üìÑ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏ô‡πâ‡∏≤
    const totalPages = computed(() =>
      Math.ceil(filteredOrders.value.length / rowsPerPage.value)
    );

    // üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
    const paginatedOrders = computed(() => {
      const start = (currentPage.value - 1) * rowsPerPage.value;
      return filteredOrders.value.slice(start, start + rowsPerPage.value);
    });

    // üîÑ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ 1
    const resetPage = () => {
      currentPage.value = 1;
    };
    watch(rowsPerPage, resetPage);

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    const updateStatus = async (order) => {
      try {
        const res = await fetch("http://localhost/project_MK/php_api/update_order_status.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            order_id: order.order_id,
            status: order.status,
          }),
        });
        const data = await res.json();
        if (!data.success) {
          alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
        }
      } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    };

    return {
      orders,
      loading,
      error,
      searchTable,
      currentPage,
      rowsPerPage,
      totalPages,
      paginatedOrders,
      updateStatus,
    };
  },
};
</script>

<style scoped>
.table {
  font-size: 0.95rem;
}
select {
  border-radius: 8px;
  padding: 4px 8px;
}
</style>
